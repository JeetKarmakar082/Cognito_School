

{% extends "scheduler/college-base.html" %}
{% block content %}
<div class="container mt-4">
    <h3 class="mb-3">Timetable Entry Details</h3>
    <table class="table table-bordered">
        <tr><th>Day</th><td>{{ entry.time_slot.day }}</td></tr>
        <tr><th>Time</th><td>{{ entry.time_slot.start_time }} - {{ entry.time_slot.end_time }}</td></tr>
        <tr><th>Subject</th><td>{{ entry.subject.name }}</td></tr>
        <tr><th>Faculty</th><td>{{ entry.faculty.employee_name }}</td></tr>
        <tr><th>Classroom</th><td>{{ entry.classroom.name }}</td></tr>
        <tr><th>Batch</th><td>{{ entry.batch.name }}</td></tr>
    </table>
    <a href="{% url 'export_timetable' entry.id %}" class="btn btn-success">
        <i class="bi bi-download"></i> Export CSV
    </a>
</div>
{% endblock %}




{% comment %} {% extends 'scheduler/college-base.html' %}
{% load static %}

{% block title %}{{ template.name }} - Timetable View{% endblock %}

{% block extra_css %}
<style>
.timetable-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.timetable-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
}

.timetable-grid {
    display: grid;
    grid-template-columns: 100px repeat(6, 1fr);
    gap: 1px;
    background-color: #dee2e6;
}

.timetable-cell {
    background-color: white;
    padding: 0.75rem;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    transition: all 0.3s ease;
}

.timetable-cell.header {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.timetable-cell.time-slot {
    background-color: #667eea;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
}

.timetable-cell.occupied {
    background-color: #e8f5e8;
    border-left: 4px solid #28a745;
}

.timetable-cell.break-time {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
}

.timetable-cell:hover {
    background-color: rgba(102, 126, 234, 0.05);
    transform: scale(1.02);
}

.subject-code {
    font-weight: 600;
    color: #667eea;
    font-size: 0.9rem;
}

.faculty-name {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.room-info {
    font-size: 0.75rem;
    color: #adb5bd;
    margin-top: 0.25rem;
}

.batch-selector {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.legend {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
}

@media (max-width: 768px) {
    .timetable-grid {
        display: block;
    }
    
    .timetable-cell {
        margin-bottom: 0.5rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .batch-selector {
        text-align: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" data-template-id="{{ template.id }}">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">{{ template.name }}</h1>
                    <p class="text-muted mb-0">
                        {{ template.department.name }} - Semester {{ template.semester }} - {{ template.academic_year }}
                    </p>
                </div>
                <div class="btn-group">
                    {% if not template.is_approved and user.is_staff %}
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal">
                            <i class="bi bi-check-circle"></i> Approve
                        </button>
                    {% endif %}
                    <a href="{% url 'export_timetable' template.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-download"></i> Export CSV
                    </a>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'create_timetable' %}">
                                <i class="bi bi-plus-circle"></i> Create New
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            {% if template.created_by == user or user.is_staff %}
                                <li>
                                    <form method="post" action="{% url 'delete_timetable' template.id %}" 
                                          onsubmit="return confirm('Are you sure you want to delete this timetable?')">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item text-danger">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </form>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Status Indicators -->
            <div class="mt-2">
                {% if template.is_approved %}
                    <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i> Approved
                    </span>
                {% elif template.is_active %}
                    <span class="badge bg-warning">
                        <i class="bi bi-clock"></i> Active
                    </span>
                {% else %}
                    <span class="badge bg-secondary">
                        <i class="bi bi-file-text"></i> Draft
                    </span>
                {% endif %}
                
                <small class="text-muted ms-2">
                    Created by {{ template.created_by.get_full_name|default:template.created_by.username }} 
                    on {{ template.created_at|date:"M d, Y" }}
                </small>
            </div>
        </div>
    </div>

    <!-- Batch Selector -->
    <div class="batch-selector">
        <div class="row align-items-center">
            <div class="col-md-6">
                <label for="batchSelect" class="form-label fw-bold">Select Batch to View:</label>
                <select id="batchSelect" class="form-select">
                    {% for batch, schedule in timetable_data.items %}
                        <option value="{{ batch.id }}">{{ batch.name }} ({{ batch.student_count }} students)</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e8f5e8; border-left: 4px solid #28a745;"></div>
                        <span>Class</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #fff3cd; border-left: 4px solid #ffc107;"></div>
                        <span>Break</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f8f9fa;"></div>
                        <span>Free Period</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timetable Display -->
    {% for batch, schedule in timetable_data.items %}
        <div class="timetable-container batch-timetable" data-batch-id="{{ batch.id }}" style="{% if not forloop.first %}display: none;{% endif %}">
            <div class="timetable-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-1">{{ batch.name }} Timetable</h4>
                        <p class="mb-0 opacity-75">
                            {{ batch.program|title }} Program - {{ batch.student_count }} Students
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <small>
                            Max Classes/Day: {{ template.max_classes_per_day }}<br>
                            Department: {{ batch.department.name }}
                        </small>
                    </div>
                </div>
            </div>

            <div class="timetable-grid">
                <!-- Header Row -->
                <div class="timetable-cell header">Time</div>
                {% for day_key, day_name in days.items %}
                    <div class="timetable-cell header">{{ day_name|title }}</div>
                {% endfor %}

                <!-- Time Slots -->
                {% for slot in time_slots %}
                    <div class="timetable-cell time-slot">
                        <div>{{ slot.start_time|time:"H:i" }}</div>
                        <div>{{ slot.end_time|time:"H:i" }}</div>
                    </div>
                    
                    {% for day in days %}
                        {% with entry=schedule|default_if_none:""|lookup:day|default_if_none:""|lookup:slot %}
                            <div class="timetable-cell {% if entry %}occupied{% elif slot.is_break %}break-time{% endif %}"
                                 data-day="{{ day }}" data-time-slot="{{ slot.id }}"
                                 {% if entry %}data-entry-id="{{ entry.id }}"{% endif %}>
                                {% if entry %}
                                    <div class="subject-code">{{ entry.subject.code }}</div>
                                    <div class="subject-name">{{ entry.subject.name|truncatechars:20 }}</div>
                                    <div class="faculty-name">{{ entry.faculty.user.get_full_name|truncatechars:15 }}</div>
                                    <div class="room-info">{{ entry.classroom.name }}</div>
                                {% elif slot.is_break %}
                                    <div class="break-label">
                                        <i class="bi bi-cup-hot"></i><br>
                                        BREAK
                                    </div>
                                {% else %}
                                    <div class="text-muted">
                                        <i class="bi bi-dash"></i>
                                    </div>
                                {% endif %}
                            </div>
                        {% endwith %}
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
    {% endfor %}

    <!-- Approval Modal -->
    {% if not template.is_approved and user.is_staff %}
        <div class="modal fade" id="approveModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Approve Timetable</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to approve this timetable?</p>
                        <p><strong>{{ template.name }}</strong> for {{ template.department.name }} - Semester {{ template.semester }}</p>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Approving this timetable will make it active and deactivate other timetables for the same department and semester.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form method="post" action="{% url 'approve_timetable' template.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Approve Timetable
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Batch selector functionality
document.addEventListener('DOMContentLoaded', function() {
    const batchSelect = document.getElementById('batchSelect');
    const batchTimetables = document.querySelectorAll('.batch-timetable');
    
    batchSelect.addEventListener('change', function() {
        const selectedBatchId = this.value;
        
        // Hide all timetables
        batchTimetables.forEach(timetable => {
            timetable.style.display = 'none';
        });
        
        // Show selected batch timetable
        const selectedTimetable = document.querySelector(`[data-batch-id="${selectedBatchId}"]`);
        if (selectedTimetable) {
            selectedTimetable.style.display = 'block';
            selectedTimetable.classList.add('fade-in');
        }
    });
    
    // Add hover effects to timetable cells
    document.querySelectorAll('.timetable-cell.occupied').forEach(cell => {
        cell.addEventListener('mouseenter', function() {
            // Highlight related cells (same subject, faculty, or room)
            const entryId = this.dataset.entryId;
            if (entryId) {
                document.querySelectorAll(`[data-entry-id="${entryId}"]`).forEach(relatedCell => {
                    relatedCell.classList.add('highlight');
                });
            }
        });
        
        cell.addEventListener('mouseleave', function() {
            // Remove highlight
            document.querySelectorAll('.highlight').forEach(cell => {
                cell.classList.remove('highlight');
            });
        });
    });
});

// Template lookup filter (custom template filter simulation)
if (!String.prototype.lookup) {
    String.prototype.lookup = function(key) {
        return this[key] || '';
    };
}
</script>

<style>
.highlight {
    background-color: rgba(102, 126, 234, 0.2) !important;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
}

.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %} {% endcomment %}

